# Game Logs Processor

Подробное описание конвейера обработки игровых логов, требований и сценариев запуска.
Все предупреждения и информационные сообщения логируются в файл `app.log` в
корне репозитория.

## Назначение
Приложение читает два больших лога (предметы и деньги), объединяет их в единый
временной поток, строит статистику по предметам и игрокам, записывает результаты
в файлы `combined_log.txt` и `output.txt`, а затем позволяет интерактивно
спрашивать сводку по конкретному `item_type_id`.

## Требования и окружение
- **Рекомендуемый способ запуска — через Docker.** Базовый образ использует
  `python:2.7.18-slim`, что полностью соответствует требованиям ТЗ.
- Для локального прогона вне контейнера нужен **Python 2.7.18**, дополнительные
  зависимости отсутствуют (пустой `requirements.txt`).
- Логи и справочные данные ожидаются в каталоге `data/` (см. структуру ниже).
- Все системные логи пишутся в `app.log` в корне проекта (создаётся автоматически при первом запуске).

## Структура данных
```
data/
├── raw/
│   ├── inventory_logs.txt   # поток событий по предметам
│   └── money_logs.txt       # поток событий по деньгам
├── reference/
│   ├── db.json              # справочник игроков (имя, уровень)
│   └── items.xml            # справочник предметов (id → name)
└── output/
    ├── combined_log.txt     # будет создан при слиянии логов
    └── output.txt           # будет создан со статистикой
```
Пути централизованно заданы в `config.py`, поэтому при перемещении файлов
достаточно обновить значения там.

## Ключевые модули
- `src/parsers.py` — потоковые парсеры логов предметов и денег. Читают строки
  построчно, валидируют формат, пропускают некорректные записи и возвращают
  именованные кортежи событий.
- `src/state.py` — модели `Player`, `PlayerRegistry`, `ItemStatistics` и
  `GameState`. Применяют события, учитывают баланс, инвентарь, владельцев и
  хронологию появления предметов.
- `src/combiner.py` — слияние двух потоков событий по времени в
  `combined_log.txt` с приоритетом строк из лога предметов при совпадающих
  метках времени.
- `src/report.py` — загрузка каталога предметов, формирование `output.txt` и
  интерактивный режим ответов по `item_type_id`.
- `config.py` — единый источник путей к данным, выходным файлам и пути логов.
- `src/logging_setup.py` — конфигурация логов с записью в `app.log` и выводом в stdout.

## Быстрый запуск полного конвейера (Docker)
Ниже пример, где весь код выполняется внутри контейнера. Он пройдёт стадии
слияния логов, построения состояния, записи статистики и интерактивного режима.
Перед запуском убедитесь, что входные файлы расположены в `data/` согласно
разделу «Структура данных».

```bash
  # 1) Собрать образ (однократно)
docker build -t game-logs-processor .
```
```bash
  # 2) Запустить конвейер внутри контейнера; пробрасываем каталог данных и лог
touch app.log  
docker run --rm -it \
  -v "$(pwd)/data:/app/data" \
  -v "$(pwd)/app.log:/app/app.log" \
  game-logs-processor bash -lc "python main.py"
```

## Альтернативный локальный запуск
Если Docker недоступен, тот же сценарий можно выполнить напрямую в установленном
Python 2.7.18. 
Перед запуском убедитесь, что в каталоге проекта есть права на запись файла
`app.log` — при старте `main.py` настроит логирование и создаст этот файл
автоматически.

```bash
  python main.py
```

## Описание выходов
- `combined_log.txt` — объединённый хронологический поток со строками вида
  `[YY-MM-DD HH:MM:SS] player_id | ITEM_ADD (item_type_id, amount) ...` или
  `[YY-MM-DD HH:MM:SS] player_id | MONEY_ADD | amount | reason`.
- `output.txt` — четыре блока статистики: топ-10 предметов по упоминаниям,
  топ-10 игроков по балансу с датами первого/последнего события, первые 10
  предметов по времени появления, последние 10 предметов по времени появления.
- Интерактивный вывод — для введённого `item_type_id` сообщает название
  предмета, общее количество экземпляров в игре, число владельцев и топ-10
  игроков по этому предмету.

## Диагностика и логирование
- Модули парсеров и слияния используют стандартный `logging` для предупреждений
  о некорректных строках и прогресса обработки. Функция `configure_logging` из
  `src/logging_setup.py` добавляет запись в `app.log` (корень проекта) и
  дублирует вывод в stdout.
- В Docker-примере файл `app.log` пробрасывается на хост через volume
  `-v "$(pwd)/app.log:/app/app.log"`, поэтому логи доступны даже после
  завершения контейнера.

## Ограничения и допущения
- Код рассчитан на объём до ~10 млн строк логов: чтение потоковое, без загрузки
  файлов целиком в память.
- Баланс денег игрока может уходить в минус — это предусмотрено моделями
  состояния.
- При равных временных метках события из `inventory_logs.txt` пишутся в
  `combined_log.txt` раньше событий из `money_logs.txt`.

## Дополнительные материалы
- Полное техническое задание: `docs/TASK.md`.